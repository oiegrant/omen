Phase 4: Bulk DB writes (few queries)
Bulk insert (new events)
INSERT INTO events (...)
VALUES
  (...),
  (...),
  (...)
ON CONFLICT DO NOTHING;

Bulk update (only changed rows)
UPDATE events
SET
  expiry_date = data.expiry_date,
  updated_at = now()
FROM (
  VALUES
    ($1, $2),
    ($3, $4)
) AS data(venue_event_id, expiry_date)
WHERE events.venue_event_id = data.venue_event_id
  AND events.venue = 'polymarket';

Mark expired events
UPDATE events
SET status = 'expired',
    updated_at = now()
WHERE venue = 'polymarket'
  AND venue_event_id = ANY(%s);

CREATE INDEX idx_events_venue_lookup
ON canonical_events (venue, venue_event_id);

-- Fast active scans
CREATE INDEX idx_events_status
ON canonical_events (status);

-- Incremental sync / diffing
CREATE INDEX idx_events_updated_at
ON canonical_events (updated_at);

-- Expiry-based cleanup or transitions
CREATE INDEX idx_events_expiry
ON canonical_events (expiry_date);

SELECT event_id, data_hash
FROM canonical_events
WHERE venue = $1 AND venue_event_id = $2;
